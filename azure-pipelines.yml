trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: JFrog-Secrets  # contains artifactoryUser, artifactoryPassword, ARTIFACTORY_URL, ARTIFACTORY_REPO

steps:
- checkout: self

- script: |
    curl -fL https://getcli.jfrog.io | sh
    sudo mv jfrog /usr/local/bin/jfrog
  displayName: 'Install JFrog CLI'

- script: |
    echo "ARTIFACTORY_URL is: $(ARTIFACTORY_URL)"
  displayName: 'Debug Artifactory URL'

- script: |
    jfrog config add devops-jfrog \
      --url="$(ARTIFACTORY_URL)" \
      --user="$(artifactoryUser)" \
      --password="$(artifactoryPassword)" \
      --interactive=false
  displayName: 'Configure JFrog CLI'

- script: |
    export MAVEN_OPTS="--add-opens java.base/java.util=ALL-UNNAMED"
    jfrog rt mvn clean install deploy \
      --build-name="jfrog-maven-build" \
      --build-number="$(Build.BuildId)"
  displayName: 'Build and Deploy with JFrog CLI'

- script: |
    jfrog rt build-publish jfrog-maven-build $(Build.BuildId)
  displayName: 'Publish Build Info to Artifactory'
