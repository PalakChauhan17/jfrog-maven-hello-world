trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  ARTIFACTORY_URL: 'https://trialrgyqe6.jfrog.io/artifactory'
  ARTIFACTORY_REPO: 'devops-demo-repo-libs-snapshot'
  MAVEN_PROJECT_DIR: '.'

steps:
- checkout: self

# Import secret variable group here
- task: AzurePipeline@1
  inputs:
    script: echo "Using secret group"
  env:
    artifactoryUser: $(artifactoryUser)
    artifactoryPassword: $(artifactoryPassword)

- script: |
    curl -fL https://getcli.jfrog.io | sh
    sudo mv jfrog /usr/local/bin/jfrog
  displayName: 'Install JFrog CLI'

- script: |
    jfrog config add devops-jfrog \
      --url=$(ARTIFACTORY_URL) \
      --user=$(artifactoryUser) \
      --password=$(artifactoryPassword) \
      --interactive=false
  displayName: 'Configure JFrog CLI'

- script: |
    mkdir -p ~/.jfrog/projects
    echo "type: maven" > ~/.jfrog/projects/maven.yaml
    echo "resolver:" >> ~/.jfrog/projects/maven.yaml
    echo "  serverId: devops-jfrog" >> ~/.jfrog/projects/maven.yaml
    echo "  repo: devops-demo-repo-libs-snapshot" >> ~/.jfrog/projects/maven.yaml
    echo "deployer:" >> ~/.jfrog/projects/maven.yaml
    echo "  serverId: devops-jfrog" >> ~/.jfrog/projects/maven.yaml
    echo "  repo: devops-demo-repo-libs-snapshot" >> ~/.jfrog/projects/maven.yaml
  displayName: 'Create JFrog CLI Maven project config'

- script: |
    mvn clean install
  displayName: 'Maven Build'

- script: |
    jfrog rt mvn deploy \
      --build-name="jfrog-maven-build" \
      --build-number="$(Build.BuildId)"
  displayName: 'Deploy to Artifactory using JFrog CLI'

- script: |
    jfrog rt build-publish jfrog-maven-build $(Build.BuildId)
  displayName: 'Publish Build Info to Artifactory'
