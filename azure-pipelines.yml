trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: JFrog-Secrets  # Make sure this group contains artifactoryUser, artifactoryPassword, ARTIFACTORY_URL, ARTIFACTORY_REPO

steps:
- checkout: self

# Install JFrog CLI
- script: |
    curl -fL https://getcli.jfrog.io | sh
    sudo mv jfrog /usr/local/bin/jfrog
  displayName: 'Install JFrog CLI'

# Debug: Show Artifactory URL variable
- script: |
    echo "ARTIFACTORY_URL is: '$(ARTIFACTORY_URL)'"
  displayName: 'Debug: Show Artifactory URL'

# Configure JFrog CLI with correct URL including /artifactory
- script: |
    jfrog config add devops-jfrog \
      --url=$(ARTIFACTORY_URL) \
      --user=$(artifactoryUser) \
      --password=$(artifactoryPassword) \
      --interactive=false

    # Verify the connection with ping
    jfrog rt ping
  displayName: 'Configure JFrog CLI and Ping Artifactory'

# Create JFrog CLI Maven project config
- script: |
    mkdir -p ~/.jfrog/projects
    echo "type: maven" > ~/.jfrog/projects/maven.yaml
    echo "resolver:" >> ~/.jfrog/projects/maven.yaml
    echo "  serverId: devops-jfrog" >> ~/.jfrog/projects/maven.yaml
    echo "  repo: $(ARTIFACTORY_REPO)" >> ~/.jfrog/projects/maven.yaml
    echo "deployer:" >> ~/.jfrog/projects/maven.yaml
    echo "  serverId: devops-jfrog" >> ~/.jfrog/projects/maven.yaml
    echo "  repo: $(ARTIFACTORY_REPO)" >> ~/.jfrog/projects/maven.yaml
  displayName: 'Create JFrog CLI Maven project config'

# Clear Maven local repository cache to avoid conflicts
- script: |
    rm -rf ~/.m2/repository
  displayName: 'Clear Maven Local Repository Cache'

# Verify Java and Maven versions
- script: |
    java -version
    mvn -version
  displayName: 'Verify Java and Maven Versions'

# Run Maven build with debug logging (-X)
- script: |
    export MAVEN_OPTS="--add-opens java.base/java.util=ALL-UNNAMED"
    mvn clean install -X
  displayName: 'Run Maven Build with Debug Logging'

# Build and deploy using JFrog CLI
- script: |
    export MAVEN_OPTS="--add-opens java.base/java.util=ALL-UNNAMED"
    jfrog rt mvn clean install deploy \
      --build-name="jfrog-maven-build" \
      --build-number="$(Build.BuildId)"
  displayName: 'Build and Deploy to Artifactory using JFrog CLI'

# Publish build info to Artifactory
- script: |
    jfrog rt build-publish jfrog-maven-build $(Build.BuildId)
  displayName: 'Publish Build Info to Artifactory'
